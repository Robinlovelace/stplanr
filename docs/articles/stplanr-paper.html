<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>stplanr: A Package for Transport Planning • stplanr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">stplanr</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/stplanr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>stplanr: A Package for Transport Planning</h1>
                        <h4 class="author">Robin Lovelace</h4>
            <address class="author_afil">
      University of Leeds<br><a class="author_email" href="mailto:#"></a><a href="mailto:r.lovelace@leeds.ac.uk">r.lovelace@leeds.ac.uk</a>
      </address>
                              <h4 class="author">Richard Ellison</h4>
            <address class="author_afil">
      University of Sydney<br><a class="author_email" href="mailto:#"></a><a href="mailto:richard.ellison@sydney.edu.au">richard.ellison@sydney.edu.au</a>
      </address>
                  
          </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      <p>Tools for transport planning should be flexible, robust and scalable. <strong>stplanr</strong> meets each of these criteria by providing functionality commonly needed for transport planning in R, with an emphasis on spatial transport data. This includes tools to import and clean transport datasets; the creation of geographic ‘desire lines’ from origin-destination data; methods to assign these desire lines to the transport network, e.g. via interfaces to routing services such as CycleStreets.net, Graphhopper and the OpenStreetMap Routing Machine (OSRM); functions to calculate the geographic attributes of such routes, such as their bearing and equidistant surroundings; and ‘travel watershed’ analysis. With reproducible examples and using real transport datasets, this article demonstrates how R can form the basis of a reproducible and flexible transport planning workflow. We conclude with a brief discussion of desirable directions of future development.</p>
    </div>
    
<div class="contents">
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>This vignette is under peer review and was submitted in pdf form to the <a href="https://journal.r-project.org/">R Journal</a>. Please see its <a href="https://github.com/ropensci/stplanr/blob/master/vignettes/stplanr-paper.Rmd">source code</a> for comments and suggestions.</p>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Transport planning is a diverse field requiring a wide range of computational tasks . Software in the transport planner’s toolkit should be flexible, able to handle a wide range of data formats; robust, able to generate reproducible results for transparent decision-making; and scalable, able to work at multiple geographic levels from single streets to large cities and regions.</p>
<p>R can provide a solid basis for a transport planning workflow that meets each of these criteria. Packages such as   and   greatly extend R’s spatial data handling and modelling capabilities . Packages building on the <strong>sp</strong> class system have been developed for specific domains, including  ,   and the <strong>adehabitat</strong> family of packages .</p>
<p>Inspired by such efforts and driven by our own research needs, our primary aim for <strong>stplanr</strong> is to provide an R toolbox for transport planning. Although the focus is on spatial transport datasets (and most transport problems contain a spatial component), <strong>stplanr</strong> also provides functions for handling non-spatial datasets.</p>
<div id="motivations" class="section level2">
<h2 class="hasAnchor">
<a href="#motivations" class="anchor"></a>Motivations</h2>
<p>There has been little in the way of R development for transport applications. This is surprising given the ubiquity of transport problems,<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> R’s aptitude for handling transport data (including spatial and travel survey data), and the increasing use of R in applied domains. Increasingly, R is the go-to statistical software in many organisations: academic, public sector and privately owned. Such organisations undertake the majority of transport planning research. This paper was therefore motivated by the desire to demonstrate that R provides an excellent framework for transport research. If readers decide not to use the package, perhaps needing bespoke solutions to specific transport problems not covered by <strong>stplanr</strong>, it is hoped that the ideas, functions and datasets described in this paper inspire parallel developments in the space of ‘R for transport applications’. Moreover, by making the package deliberately broad in its scope, we hope that <strong>stplanr</strong> can help build a nascent community of R-using transport researchers. We welcome feature requests and feedback at the package’s <a href="https://github.com/ropensci/stplanr/issues">online home</a>.</p>
<p>R is already used in transport applications, as illustrated by recent research that applies packages from other domains to transport problems. For instance,  () use R to analyse the data collected from an online survey focused on car-sharing, bicycle-sharing and electric vehicles.  () also used R to collect and analyse transport-related data from Twitter using packages including ,  and . These packages were used to download, parse and plot the Twitter data using a method that can be repeated and the results reproduced or updated. More general statistical analyses have also been conducted on transport-related datasets using packages including  and  . <!-- Peter and bronsall, for example, use the xxx package to do this. --> <!-- Alfred et al, to provide another example, use the package to do that. --> Despite the rising use of R for transport research, there has yet been to be a package for transport planning.</p>
<p>The design of the R language, with its emphasis on flexibility, data processing and statistical modelling, suggests it can provide a powerful environment for transport planning research. There are many quantitative methods in transport planning  and we have attempted to focus on those that are most generalisable and frequently used. <strong>stplanr</strong> facilitates the following common computational tasks for transport planning:</p>
<ul>
<li>Accessing and processing of data on transport infrastructure and behaviour</li>
<li>Analysis and visualisation of the transport network</li>
<li>Analysis of origin-destination (OD) data and the visualisation of resulting ‘desire lines’</li>
<li>The allocation of desire lines to roads and other guideways via routing algorithms to show commonly used routes through geographical space</li>
<li>The aggregation of routes to estimate total levels of flow on segments throughout the transport network</li>
<li>Development of models to estimate transport behaviour currently and under various scenarios of change</li>
<li>The calculation of ‘catchment areas’ affected by transport infrastructure</li>
</ul>
<p>The automation of such tasks can assist researchers and practitioners to create evidence for decision making. If the data processing and analysis stages are fast and painless, more time can be dedicated to visualisation and decision making. This should allow researchers to focus on problems, rather than on wrestling with unwieldy datasets, clunky graphical user interfaces (GUIs), and ad-hoc scripts that could be generalised. Furthermore, if the process can be made reproducible and accessible (e.g. via online visualisation packages such as  and ), this will help transport planning move away from reliance on ‘black boxes’ and become a more transparent and democratic activity . <!-- Thus **stplanr** fits into the fist parts of a wider 'analyse, plan, design' workflow. - xx commented as it needs a reference--></p>
<!-- **stplanr** facilitates each of these tasks with a series of functions which, used in conjunction with R's statistical and (via packages such as **raster**) spatial capabilities, provide an integrated toolkit for computational transport planning research. Because R has a command-line interface (CLI), as opposed to the graphical user interface (GUI) approach used in many transport planning programs, it has a steep learning curve. This issue is tackled by documentation: **stplanr** has numerous example datasets (outlined in the next section), descriptive help pages (e.g see `?od2line` and `example(od2line)`) and a vignette (on which this paper is based).  -->
<p>The technical advantages of using modern, interpreted, and open source languages such as R are manifold: they enable automation and sharing of methods between researchers, for example the application of methods developed for one city to another; they ease the integration with other software systems and the web; and they have very strong user communities. The advantages of using R specifically to develop the functionality described in this paper are that it has unparalleled geo-statistical capabilities , visualisation packages (e.g. , ) and the ability to rapidly read-in data stored in many formats (e.g. via the  and  packages).</p>
<!-- As we shall see in the next section, **stplanr** provides functions for undertaking each of these methods on real data. -->
<!-- includes trip flows and calculations of catchments for transport services. -->
<!--  combined with R's increasing use in academic research, industry and the public sector, suggests there could be substantial latent demand for transport planning functionality in R.  -->
</div>
</div>
<div id="package-structure-and-functionality" class="section level1">
<h1 class="hasAnchor">
<a href="#package-structure-and-functionality" class="anchor"></a>Package structure and functionality</h1>
<p>The package can be installed and loaded in the usual way (see the package’s <a href="https://github.com/ropensci/stplanr">README</a> for dependencies and access to development versions):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">"stplanr"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stplanr)</code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<p>As illustrated by the message emitted when <strong>stplanr</strong> is loaded, it depends on . This means that the spatial data classes commonly used in the package will work with generic R functions such as <code>summary</code>, <code>aggregate</code> and, as illustrated in the figures below, <code>plot</code> .</p>
<div id="core-functions-and-classes" class="section level2">
<h2 class="hasAnchor">
<a href="#core-functions-and-classes" class="anchor"></a>Core functions and classes</h2>
<p>The package’s core functions are structured around 3 common types of spatial transport data:</p>
<ul>
<li>Origin-destination (OD) data, which report the number of people travelling between origin-destination pairs. This type of data is not explicitly spatial (OD datasets are usually represented as data frames) but represents movement over space between points in geographical space. An example is provided in the <code>flow</code> dataset.</li>
<li>Line data, one dimensional linear features on the surface of the Earth. These are typically stored as a <code>SpatialLinesDataFrame</code>.</li>
<li>Route data are special types of lines which have been allocated to the transport network. Routes typically result from the allocation of a straight ‘desire line’ allocated to the route network with a <code>route_</code> function. Route network represent many overlapping routes. All are typically stored as <code>SpatialLinesDataFrame</code>.</li>
</ul>
<p>For ease of use, functions focussed on each data type have been developed with names prefixed with <code>od_</code>, <code>line_</code> and <code>route_</code> respectively. A selection of these is presented in Table 1. Additional ‘core functions’ could be developed, such as those prefixed with <code>rn_</code> (for working with route network data) and <code>g_</code> functions for geographic operations such as buffer creation on lat/lon projected data (this function is currently named <code>buff_geo</code>). We plan to elicit feedback on such changes before implementing them.</p>
<table class="table">
<caption>Selection of functions for working with or generating OD, line and route data types.</caption>
<thead><tr class="header">
<th align="left">Function</th>
<th align="left">Input data type(s)</th>
<th align="left">Output data type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">od_dist</td>
<td align="left">Data frame</td>
<td align="left">Numeric vector</td>
</tr>
<tr class="even">
<td align="left">od_id_order</td>
<td align="left">Data frame</td>
<td align="left">Data frame</td>
</tr>
<tr class="odd">
<td align="left">line_bearing</td>
<td align="left">Spatial line</td>
<td align="left">Numeric vector</td>
</tr>
<tr class="even">
<td align="left">line_midpoint</td>
<td align="left">Spatial line</td>
<td align="left">Spatial points</td>
</tr>
<tr class="odd">
<td align="left">route_cyclestreet</td>
<td align="left">Coordinates, spatial point or text</td>
<td align="left">Spatial lines</td>
</tr>
<tr class="even">
<td align="left">route_graphhopper</td>
<td align="left">Coordinates, spatial point or text</td>
<td align="left">Spatial lines</td>
</tr>
</tbody>
</table>
<p>With a tip of the hat to the concept of type stability (e.g. as implemented in ), we also plan to make the core functions of <strong>stplanr</strong> more type-stable in future releases. Core functions, which begin with the prefixes listed above, could follow ’s lead and return only objects with the same class as that of the input. However there are limitations to this approach: it will break existing functionality and mean that output objects have a larger size than necessary (<code>line_bearing</code>, for example, does not need to duplicate the spatial data contained in its input). Instead, we plan to continue to name functions around the type of <em>input</em> data they take, but are open minded about function input-output data class conventions, especially in the context of the new class system implemented in .</p>
<p>A class system has not been developed for each data type (this option is discussed in the final section). The most common data types used in <strong>stplanr</strong> are assumed to be data frames and spatial datasets.</p>
<p>Transport datasets are very diverse. There are therefore many other functions which have more ad-hock names. Rather attempt a systematic description of each of <strong>stplanr</strong>’s functions (which can be gleaned from the online manual) it is more illuminating to see how they work together, as part of a transport planning workflow. As with most workflows, this begins with data access and ends with visualisation.</p>
</div>
<div id="accessing-and-processing-transport-data" class="section level2">
<h2 class="hasAnchor">
<a href="#accessing-and-processing-transport-data" class="anchor"></a>Accessing and processing transport data</h2>
<p>Gaining access to data is often the first stage in transport research. This is often a long and protracted process which is thankfully becoming easier thanks to the ‘open data’ movement and packages such as <strong>tigris</strong> for making data access from within R easier .</p>
<p><strong>stplanr</strong> provides a variety of different functions that facilitate importing common data formats used for transport analysis into R. Although transport analysis generally requires some transport-specific datasets, it also typically relies heavily on common sources of data including census data. This being the case, <strong>stplanr</strong> also includes functions that may be useful to those not involved in transport research. This includes the <code>read_table_builder</code> function for importing data from the Australian Bureau of Statistics (ABS) and the UK’s Stats19 road traffic casualty dataset. A brief example of the latter is demonstrated below, which begins with downloading the data (warning this downloads ~100 MB of data):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/dl_stats19.html">dl_stats19</a></span>() <span class="co"># download and extract stats19 road traffic casualty data</span></code></pre></div>
<pre><code>#&gt; [1] "Data saved at: /tmp/RtmpppF3E2/Accidents0514.csv"
#&gt; [2] "Data saved at: /tmp/RtmpppF3E2/Casualties0514.csv"
#&gt; [3] "Data saved at: /tmp/RtmpppF3E2/Vehicles0514.csv"  </code></pre>
<p>Once the data has been saved in the default directory, determined by <code>tempdir()</code>, it can be read-in and cleaned with the <code>read_stats19_</code> functions (note these call <code>format_stats19_</code> functions internally to clean the datasets and add correct labels to the variables):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ac &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_stats19_ac.html">read_stats19_ac</a></span>()
ca &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_stats19_ca.html">read_stats19_ca</a></span>()
ve &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_stats19_ve.html">read_stats19_ve</a></span>()</code></pre></div>
<p>The resulting datasets (representing accident, casualty and vehicle level data, respectively) can be merged and made geographic, as illustrated below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
ca_ac &lt;-<span class="st"> </span><span class="kw">inner_join</span>(ca, ac)
ca_cycle &lt;-<span class="st"> </span>ca_ac %&gt;%
<span class="st">  </span><span class="kw">filter</span>(Casualty_Severity ==<span class="st"> "Fatal"</span> &amp;<span class="st"> </span>!<span class="kw">is.na</span>(Latitude)) %&gt;%
<span class="st">  </span><span class="kw">select</span>(<span class="dt">Age =</span> Age_of_Casualty, <span class="dt">Mode =</span> Casualty_Type, Longitude, Latitude)
ca_sp &lt;-<span class="st"> </span><span class="kw">SpatialPointsDataFrame</span>(<span class="dt">coords =</span> ca_cycle[<span class="dv">3</span>:<span class="dv">4</span>], <span class="dt">data =</span> ca_cycle[<span class="dv">1</span>:<span class="dv">2</span>])</code></pre></div>
<p>Now that this casualty data has been cleaned, subsetted (to only include serious cycle crashes) and converted into a spatial class system, we can analyse them using geographical datasets of the type commonly used by <strong>stplanr</strong>. The following code, for example, geographically subsets the dataset to include only crashes that occured within the bounding box of a <a href="https://github.com/ropensci/stplanr/blob/master/data/route_network.rda?raw=true">route network dataset</a> provided by <strong>stplanr</strong> (from version 0.1.7 and beyond) using the function <code>bb2poly</code>, which converts a spatial dataset into a box, represented as a rectangular <code>SpatialPolygonsDataFrame</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"route_network"</span>) <span class="co"># devtools::install_github("ropensci/splanr")version 0.1.7</span>
<span class="kw">proj4string</span>(ca_sp) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(route_network)
bb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bb2poly.html">bb2poly</a></span>(route_network)
<span class="kw">proj4string</span>(bb) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(route_network)
ca_local &lt;-<span class="st"> </span>ca_sp[bb,]</code></pre></div>
<p>The above code chunk shows the importance of understanding geographical data when working with transport data. It is only by converting the casualty data into a spatial data class, and adding a coordinate reference system (CRS), that transport planners and researchers can link this important dataset back to the route network. We can now perform GIS operations on the results. The next code chunk, for example, finds all the fatalities that took place within 100 m of the route network, using the function <code>buff_geo</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rnet_buff_100 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/buff_geo.html">buff_geo</a></span>(route_network, <span class="dt">width =</span> <span class="dv">100</span>)
ca_buff &lt;-<span class="st"> </span>ca_local[rnet_buff_100,]</code></pre></div>
<p>These can be visualised using base R graphics, extended by , as illustrated in Figure . This provides a good start for analysis but for publication-quality plots and interactive plots, designed for public engagement, we recommend using dedicated visualisation packages that work with spatial data such as .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(bb, <span class="dt">lty =</span> <span class="dv">4</span>)
<span class="kw">plot</span>(rnet_buff_100, <span class="dt">col =</span> <span class="st">"grey"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">points</span>(ca_local, <span class="dt">pch =</span> <span class="dv">4</span>)
<span class="kw">points</span>(ca_buff, <span class="dt">cex =</span> <span class="dv">3</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="stplanr-paper_files/figure-html/fats-1.png" alt="Road traffic fatalities in the study area downloaded with with stplanr (crosses). Deaths that happened within 100 m of the route network are represented by circles." width="50%"><p class="caption">
Road traffic fatalities in the study area downloaded with with stplanr (crosses). Deaths that happened within 100 m of the route network are represented by circles.
</p>
</div>
</div>
<div id="creating-geographic-desire-lines" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-geographic-desire-lines" class="anchor"></a>Creating geographic desire lines</h2>
<p>Perhaps the most common type of aggregate-level transport information is origin-destination (‘OD’) data. This can be presented either as a matrix or (more commonly) a long table of OD pairs. An example of this type of raw data is provided below (see <code><a href="../reference/flow.html">?flow</a></code> to see how this dataset was created).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"flow"</span>, <span class="dt">package =</span> <span class="st">"stplanr"</span>)
<span class="kw">head</span>(flow[<span class="kw">c</span>(<span class="dv">1</span>:<span class="dv">3</span>, <span class="dv">12</span>)])</code></pre></div>
<pre><code>##        Area.of.residence Area.of.workplace All Bicycle
## 920573         E02002361         E02002361 109       2
## 920575         E02002361         E02002363  38       0
## 920578         E02002361         E02002367  10       0
## 920582         E02002361         E02002371  44       3
## 920587         E02002361         E02002377  34       0
## 920591         E02002361         E02002382   7       0</code></pre>
<p>Although the flow data displayed above describes movement over geographical space, it contains no explicitly geographical information. Instead, the coordinates of the origins and destinations are linked to a separate geographical dataset which also must be loaded to analyse the flows. This is a common problem solved by the function <code>od2line</code>. The geographical data is a set of points representing centroids of the origin and destinations, saved as a <code>SpatialPointsDataFrame</code>. Geographical data in R is best represented as such <code>Spatial*</code> objects, which use the <code>S4</code> object engine. This explains the close integration of <strong>stplanr</strong> with R’s spatial packages, especially <strong>sp</strong>, which defines the <code>S4</code> spatial object system.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"cents"</span>, <span class="dt">package =</span> <span class="st">"stplanr"</span>)
<span class="kw">as.data.frame</span>(cents[<span class="dv">1</span>:<span class="dv">3</span>, -<span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">4</span>)])</code></pre></div>
<pre><code>##       geo_code  MSOA11NM coords.x1 coords.x2
## 1708 E02002384 Leeds 055 -1.546463  53.80952
## 1712 E02002382 Leeds 053 -1.511861  53.81161
## 1805 E02002393 Leeds 064 -1.524205  53.80410</code></pre>
<p>We use <code>od2line</code> to combine <code>flow</code> and <code>cents</code>, to join the former to the latter. We will visualise the <code>l</code> object created below in the next section.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l &lt;-<span class="st"> </span><span class="kw"><a href="../reference/od2line.html">od2line</a></span>(<span class="dt">flow =</span> flow, <span class="dt">zones =</span> cents)</code></pre></div>
<p>The data is now in a form that is much easier to analyse. We can plot the data with the command <code>plot(l)</code>, which was not possible before. Because the <code>SpatialLinesDataFrame</code> object also contains data per line, it also helps with visualisation of the flows, as illustrated in Figure .</p>
</div>
<div id="allocating-flows-to-the-transport-network" class="section level2">
<h2 class="hasAnchor">
<a href="#allocating-flows-to-the-transport-network" class="anchor"></a>Allocating flows to the transport network</h2>
<p>A common problem faced by transport researchers is network allocation: converting the ‘as the crow flies’ lines illustrated in the figure above into routes. These are the complex, winding paths that people and animals make to avoid obstacles such as buildings and to make the journey faster and more efficient (e.g. by following the route network).</p>
<p>This is difficult (and was until recently near impossible using free software) because of the size and complexity of transport networks, the complexity of realistic routing algorithms and need for context-specificity in the routing engine. Inexperienced cyclists, for example, would take a very different route than a heavy goods vehicle. <strong>stplanr</strong> tackles this issue by using 3rd party APIs to provide route-allocation.</p>
<p>Route allocation is undertaken by  functions such as  and . These allocate a single OD pair, represented as a text string to be ‘geo-coded’, a pair of of coordinates, or two <code>SpatialPoints</code> objects, representing origins and destinations. This is illustrated below with <code>route_cyclestreet</code>, which uses the <a href="https://www.cyclestreets.net/api/">CycleStreets.net API</a>, a routing service “by cyclists for cyclists” that offers a range route strategies (primarily ‘fastest’, ‘quietest’ and ‘balanced’) that are based on a detailed analysis of cyclist wayfinding:<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">route_bl &lt;-<span class="st"> </span><span class="kw"><a href="../reference/route_cyclestreet.html">route_cyclestreet</a></span>(<span class="dt">from =</span> <span class="st">"Bradford"</span>, <span class="dt">to =</span> <span class="st">"Leeds"</span>)
route_c1_c2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/route_cyclestreet.html">route_cyclestreet</a></span>(cents[<span class="dv">1</span>,], cents[<span class="dv">2</span>,])</code></pre></div>
<p>The raw output from routing APIs is usually provided as a JSON or GeoJSON text string. By default, <code>route_cyclestreet</code> saves a number of key variables (including length, time, hilliness and busyness variables generated by CycleStreets.net) from the attribute data provided by the API. If the user wants to save the raw output, the <code>save_raw</code> argument can be used:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">route_bl_raw &lt;-<span class="st"> </span><span class="kw"><a href="../reference/route_cyclestreet.html">route_cyclestreet</a></span>(<span class="dt">from =</span> <span class="st">"Bradford"</span>, <span class="dt">to =</span> <span class="st">"Leeds"</span>, <span class="dt">save_raw =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Additional arguments taken by the <code>route_</code> functions depend on the routing function in question. By changing the <code>plan</code> argument of <code>route_cyclestreet</code> to <code>fastest</code>, <code>quietest</code> or <code>balanced</code>, for example, routes favouring speed, quietness or a balance between speed and quietness will be saved, respectively.</p>
<p>To automate the creation of route-allocated lines over many desire lines, the <code>line2route</code> function loops over each line, wrapping any <code>route_</code> function as an input. The output is a <code>SpatialLinesDataFrame</code> with the same number of dimensions as the input dataset (see the right panel in Figure ).</p>
<pre><code>routes_fast &lt;- line2route(l = l, route_fun = route_cyclestreet)</code></pre>
<p>The result of this ‘batch routing’ exercise is illustrated in Figure . The red lines in the left hand panel are very different from the hypothetical straight ‘desire lines’ often used in transport research, highlighting the importance of this route-allocation functionality.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(route_network, <span class="dt">lwd=</span><span class="dv">0</span>)
<span class="kw">plot</span>(l, <span class="dt">lwd =</span> l$All /<span class="st"> </span><span class="dv">10</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">lines</span>(routes_fast, <span class="dt">col =</span> <span class="st">"red"</span>)
routes_fast$All &lt;-<span class="st"> </span>l$All
rnet &lt;-<span class="st"> </span><span class="kw"><a href="../reference/overline.html">overline</a></span>(routes_fast, <span class="st">"All"</span>, <span class="dt">fun =</span> sum)
rnet$flow &lt;-<span class="st"> </span>rnet$All /<span class="st"> </span><span class="kw">mean</span>(rnet$All) *<span class="st"> </span><span class="dv">3</span>
<span class="kw">plot</span>(rnet, <span class="dt">lwd =</span> rnet$flow /<span class="st"> </span><span class="kw">mean</span>(rnet$flow))</code></pre></div>
<div class="figure">
<img src="stplanr-paper_files/figure-html/lines_routes-1.png" alt="Visualisation of travel desire lines, with width proportional to number of trips between origin and destination (black) and routes allocated to network  (red) in the left-hand panel. The right hand panel shows the route network dataset generated by overline()." width="50%"><img src="stplanr-paper_files/figure-html/lines_routes-2.png" alt="Visualisation of travel desire lines, with width proportional to number of trips between origin and destination (black) and routes allocated to network  (red) in the left-hand panel. The right hand panel shows the route network dataset generated by overline()." width="50%"><p class="caption">
Visualisation of travel desire lines, with width proportional to number of trips between origin and destination (black) and routes allocated to network (red) in the left-hand panel. The right hand panel shows the route network dataset generated by overline().
</p>
</div>
<p>To estimate the amount of capacity needed at each segment on the transport network, the <code>overline</code> function demonstrated above, is used to divide line geometries into unique segments and aggregate the overlapping values. The results, illustrated in the right-hand panel of Figure , can be used to estimate where there is most need to improve the transport network, for example informing the decision of where to build new bicycle paths.</p>
<p>Limitations with the <code>route_cyclestreet</code> routing API include its specificity, to one mode (cycling) and a single region (the UK and part of Europe). To overcome these limitations, additional routing APIs were added with the functions <code>route_graphhopper</code>, <code>route_transportapi_public</code> and <code>viaroute</code>. These interface to Graphhopper, TransportAPI and the Open Source Routing Machine (OSRM) routing services, respectively. The great advantage of OSRM is that it allows you to run your own routing services on a local server, greatly increasing the rate of route generation.</p>
<p>A short example of finding the route by car and bike between New York and Oaxaca demonstrates how <code>route_graphhopper</code> can collect geographical and other data on routes by various modes, anywhere in the world. The output, shown in Table , shows that the function also saves time, distance and (for bike trips) vertical distance climbed for the trips.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ny2oaxaca1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/route_graphhopper.html">route_graphhopper</a></span>(<span class="st">"New York"</span>, <span class="st">"Oaxaca"</span>, <span class="dt">vehicle =</span> <span class="st">"bike"</span>)
ny2oaxaca2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/route_graphhopper.html">route_graphhopper</a></span>(<span class="st">"New York"</span>, <span class="st">"Oaxaca"</span>, <span class="dt">vehicle =</span> <span class="st">"car"</span>)
<span class="kw">rbind</span>(ny2oaxaca1@data, ny2oaxaca2@data)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">time</th>
<th align="right">dist</th>
<th align="right">change_elev</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">17522.73</td>
<td align="right">4885663</td>
<td align="right">87388.13</td>
</tr>
<tr class="even">
<td align="right">2759.89</td>
<td align="right">4754772</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<!-- ## Calculating geographic attributes of transport routes -->
</div>
<div id="modelling-travel-catchment-areas" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-travel-catchment-areas" class="anchor"></a>Modelling travel catchment areas</h2>
<p>Accessibility to transport services is a particularly important topic when considering public transport or active travel because of the frequent steep reduction in use as distances to access services (or infrastructure) increase. As a result, the planning for transport services and infrastructure frequently focuses on several measures of accessibility including distance, but also travel times and frequencies and weighted by population. The functions in <strong>stplanr</strong> are intended to provide a method of estimating these accessibility measures as well as calculating the population that can access specific services (i.e., estimating the catchment area).</p>
<p>Catchment areas in particular are a widely used measure of accessibility that attempts to both quantify the likely target group for a particular service, and visualise the geographic area that is covered by the service. For instance, passengers are often said to be willing to walk up to 400 metres to a bus stop, or 800 metres to a railway station . Although these distances may appear relatively arbitrary and have been found to underestimate the true catchment area of bus stops and railway stations  they nonetheless represent a good, albeit somewhat conservative, starting point from which catchment areas can be determined.</p>
<p>In many cases, catchment areas are calculated on the basis of straight-line (or “as the crow flies”) distances. This is a simplistic, but relatively appealing approach because it requires little additional data and is straight-forward to understand. <strong>stplanr</strong> provides functionality that calculates catchment areas using straight-line distances with the <code>calc_catchment</code> function. This function takes a <code>SpatialPolygonsDataFrame</code> that contains the population (or other) data, typically from a census, and a <code>Spatial*</code> layer that contains the geometry of the transport facility. These two layers are overlayed to calculate statistics for the desired catchments including proportioning polygons to account for the proportion located within the catchment area.</p>
<p>To illustrate how catchment areas can be calculated, <strong>stplanr</strong> contains some sample datasets stored in ESRI Shapefile format (a commonly used format for distributing GIS layers) that can together be used to calculate sample catchment areas. One of these datasets (<code>smallsa1</code>) contains population data for Statistical Area 1 (SA1) zones in Sydney, Australia. The second contains hypothetical cycleways aligned to streets in Sydney. The code below unzips the datasets and reads in the shapefiles using the <code>readOGR</code> function of .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_dir &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="dt">package =</span> <span class="st">"stplanr"</span>)
<span class="kw">unzip</span>(<span class="kw">file.path</span>(data_dir, <span class="st">'smallsa1.zip'</span>))
<span class="kw">unzip</span>(<span class="kw">file.path</span>(data_dir, <span class="st">'testcycleway.zip'</span>))
sa1income &lt;-<span class="st"> </span>rgdal::<span class="kw">readOGR</span>(<span class="st">"."</span>, <span class="st">"smallsa1"</span>)
testcycleway &lt;-<span class="st"> </span>rgdal::<span class="kw">readOGR</span>(<span class="st">"."</span>, <span class="st">"testcycleway"</span>)
<span class="co"># Remove unzipped files</span>
<span class="kw">file.remove</span>(<span class="kw">list.files</span>(<span class="dt">pattern =</span> <span class="st">"^(smallsa1|testcycleway).*"</span>))</code></pre></div>
<p>Calculating the catchment area is straightforward and in addition to specifying the required datasets, only a vector containing column names to calculate statistics and a distance is required. Since proportioning the areas assumes projected data, unprojected data are automatically projected to either a common projection (if one is already projected) or a specified projection. It should be emphasised that the choice of projection is important and has an effect on the results meaning setting a local projection is recommended to achieve the most accurate results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">catch800m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_catchment.html">calc_catchment</a></span>(
  <span class="dt">polygonlayer =</span> sa1income,
  <span class="dt">targetlayer =</span> testcycleway,
  <span class="dt">calccols =</span> <span class="kw">c</span>(<span class="st">'Total'</span>),
  <span class="dt">distance =</span> <span class="dv">800</span>,
  <span class="dt">projection =</span> <span class="st">'austalbers'</span>,
  <span class="dt">dissolve =</span> <span class="ot">TRUE</span>
)</code></pre></div>
<p>By looking at the data.frame associated with the SpatialPolygonsDataFrame that is returned from the <code>calc_catchment</code> function, the total population within the catchment area can be seen to be 39418 people. The catchment area can also be plotted as with any other <code>Spatial*</code> object using the <code>plot</code> function using the code below with the result shown in Figure .</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(sa1income, <span class="dt">col =</span> <span class="st">"light grey"</span>)
<span class="kw">plot</span>(catch800m, <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(testcycleway, <span class="dt">col =</span> <span class="st">"green"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure">
<img src="stplanr-paper_files/figure-html/catchmentplot-1.png" alt="An 800 metre catchment area (red) associated with a cycle path (green) using straight-line distance in Sydney." width="672"><p class="caption">
An 800 metre catchment area (red) associated with a cycle path (green) using straight-line distance in Sydney.
</p>
</div>
<p>This simplistic catchment area is useful when the straight-line distance is a reasonable approximation of the route taken to walk (or cycle) to a transport facility. However, this is often not the case. The catchment area in Figure  initially appears reasonable but the red-shaded catchment area includes an area that requires travelling around a bay to access from the (green-coloured) cycleway. To allow for more realistic catchment areas for most situations, <strong>stplanr</strong> provides the <code>calc_network_catchment</code> function that uses the same principle as <code>calc_catchment</code> but also takes into account the transport network.</p>
<p>To use <code>calc_network_catchment</code>, a transport network needs to be prepared that can be used in conjunction with the previous datasets. Preparation of the dataset involves using the <code>SpatialLinesNetwork</code> function to create a network from a <code>SpatialLinesDataFrame</code>. This function combines a <code>SpatialLinesDataFrame</code> with a graph network (using the  package) to provide basic routing functionality. The network is used to calculate the shortest actual paths within the specific catchment distance. This process involves the following code:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">unzip</span>(<span class="kw">file.path</span>(data_dir, <span class="st">'sydroads.zip'</span>))
sydroads &lt;-<span class="st"> </span>rgdal::<span class="kw">readOGR</span>(<span class="st">"."</span>, <span class="st">"roads"</span>)
<span class="kw">file.remove</span>(<span class="kw">list.files</span>(<span class="dt">pattern =</span> <span class="st">"^(roads).*"</span>))
sydnetwork &lt;-<span class="st"> </span><span class="kw"><a href="../reference/SpatialLinesNetwork.html">SpatialLinesNetwork</a></span>(sydroads)</code></pre></div>
<p>The network catchment is then calculated using a similar method as with <code>calc_catchment</code> but with a few minor changes. Specifically these are including the <code>SpatialLinesNetwork</code>, and using the <code>maximpedance</code> parameter to define the distance, with distance being the additional distance from the network. In contrast to the distance parameter that is based on the straight-line distance in both the <code>calc_catchment</code> and <code>calc_network_catchment</code> functions, the <code>maximpedance</code> parameter is the maximum value in the units of the network’s weight attribute. In practice this is generally distance in metres but can also be travel times, risk or other measures.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">netcatch800m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calc_network_catchment.html">calc_network_catchment</a></span>(
  <span class="dt">sln =</span> sydnetwork,
  <span class="dt">polygonlayer =</span> sa1income,
  <span class="dt">targetlayer =</span> testcycleway,
  <span class="dt">calccols =</span> <span class="kw">c</span>(<span class="st">'Total'</span>),
  <span class="dt">maximpedance =</span> <span class="dv">800</span>,
  <span class="dt">distance =</span> <span class="dv">100</span>,
  <span class="dt">projection =</span> <span class="st">'austalbers'</span>
)</code></pre></div>
<p>Once calculated, the network catchment area can be used just as the straight-line network catchment. This includes extracting the catchment population of 23457 and plotting the original catchment area together with the original area with the results shown in Figure :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(sa1income, <span class="dt">col =</span> <span class="st">"light grey"</span>)
<span class="kw">plot</span>(catch800m, <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(netcatch800m, <span class="dt">col =</span> <span class="kw">rgb</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.5</span>), <span class="dt">add =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(testcycleway, <span class="dt">col =</span> <span class="st">"green"</span>, <span class="dt">add =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure">
<img src="stplanr-paper_files/figure-html/netcatchplot-1.png" alt="A 800 metre network catchment are (blue) compared with a catchment area based on Euclidean distance (red) associated with a cycle path (green)." width="672"><p class="caption">
A 800 metre network catchment are (blue) compared with a catchment area based on Euclidean distance (red) associated with a cycle path (green).
</p>
</div>
</div>
</div>
<div id="modelling-and-visualisation" class="section level1">
<h1 class="hasAnchor">
<a href="#modelling-and-visualisation" class="anchor"></a>Modelling and visualisation</h1>
<div id="modelling-mode-choice" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-mode-choice" class="anchor"></a>Modelling mode choice</h2>
<p>Route-allocated lines allow estimation of <em>route distance</em> and <em>cirquity</em> (route distance divided by Euclidean distance). These variables can help model the rate of flow between origins and destination, as illustrated in the left-hand panel of Figure . The code below demonstrates how objects generated by <strong>stplanr</strong> can be used to undertake such analysis, with the <code>line_length</code> function used to find the distance, in meters, of lat/lon data.</p>
<pre><code>l$d_euclidean &lt;- line_length(l)
l$d_rf &lt;- routes_fast@data$length
plot(l$d_euclidean, l$d_rf,
  xlab = "Euclidean distance", ylab = "Route distance")
abline(a = 0, b = 1)
abline(a = 0, b = 1.2, col = "green")
abline(a = 0, b = 1.5, col = "red")</code></pre>
<p>The left hand panel of Figure  shows the expected strong correlation between Euclidean (<span class="math inline">\(d_E\)</span>) and fastest route (<span class="math inline">\(d_{Rf}\)</span>) distance. However, some OD pairs have a proportionally higher route distance than others, as illustrated by distance from the black line in the above plot: this represents : the ratio of network distance to Euclidean distance :</p>
<p><span class="math display">\[
 Q = \frac{d_{Rf}}{d_E}
\]</span></p>
<p>An extension to the concept of cirquity is the ‘quietness diversion factor’ (<span class="math inline">\(QDF\)</span>) of a desire line , the ratio of the route distance of a quiet route option (<span class="math inline">\(d_{Rq}\)</span>) to that of the fastest:</p>
<p><span class="math display">\[
 QDF = \frac{d_{Rq}}{d_{Rf}}
\]</span></p>
<p>Thanks to the ‘quietest’ route option provided by <code>route_cyclestreet</code>, we can estimate average values for both metrics as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">routes_slow &lt;-<span class="st"> </span><span class="kw"><a href="../reference/line2route.html">line2route</a></span>(l, route_cyclestreet, <span class="dt">plan =</span> <span class="st">"quietest"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l$d_rq &lt;-<span class="st"> </span>routes_slow$length <span class="co"># quietest route distance</span>
Q &lt;-<span class="st"> </span><span class="kw">mean</span>(l$d_rf /<span class="st"> </span>l$d_euclidean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
QDF &lt;-<span class="st"> </span><span class="kw">mean</span>(l$d_rq /<span class="st"> </span>l$d_rf, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
Q</code></pre></div>
<pre><code>## [1] 1.298767</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">QDF</code></pre></div>
<pre><code>## [1] 1.034721</code></pre>
<p>The results show that cycle paths are not particularly direct in the study region by international standards . This is hardly surprisingly given the small size of the sample and the short distances covered: <span class="math inline">\(Q\)</span> tends to decrease at a decaying rate with distance. What is surprising is that <span class="math inline">\(QDF\)</span> is close to unity, which could imply that the quiet routes are constructed along direct, and therefore sensible routes. We should caution against such assumptions, however: It is a small sample of desire lines and, when time is explored, we find that the ‘quietness diversion factor with respect to time’ (<span class="math inline">\(QDF_t\)</span>) is slightly larger:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(QDFt &lt;-<span class="st"> </span><span class="kw">mean</span>(routes_slow$time /<span class="st"> </span>routes_fast$time, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre></div>
<pre><code>## [1] 1.052855</code></pre>
</div>
<div id="models-of-travel-behaviour" class="section level2">
<h2 class="hasAnchor">
<a href="#models-of-travel-behaviour" class="anchor"></a>Models of travel behaviour</h2>
<p>There are many ways of estimating flows between origins and destinations, including spatial interaction models, the four-stage transport model and gravity models (‘distance decay’). <strong>stplanr</strong> aims eventually to facilitate creation of many types of flow model.</p>
<p>At present there are no functions for modelling distance decay, but this is something we would like to add in future versions of <strong>stplanr</strong>. Distance decay is an especially important concept for sustainable transport planning due to physical limitations on the ability of people to walk and cycle large distances .</p>
<p>We can explore the relationship between distance and the proportion of trips made by walking, using the same object <code>l</code> generated by <strong>stplanr</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">l$pwalk &lt;-<span class="st"> </span>l$On.foot /<span class="st"> </span>l$All
<span class="kw">plot</span>(l$d_euclidean, l$pwalk, <span class="dt">cex =</span> l$All /<span class="st"> </span><span class="dv">50</span>,
  <span class="dt">xlab =</span> <span class="st">"Euclidean distance (m)"</span>, <span class="dt">ylab =</span> <span class="st">"Proportion of trips by foot"</span>)</code></pre></div>
<div class="figure">
<img src="stplanr-paper_files/figure-html/euclidfastest-1.png" alt="Euclidean and fastest route distance of trips in the study area (left) and Euclidean distance vs the proportion of trips made by walking (right)." width="100%"><p class="caption">
Euclidean and fastest route distance of trips in the study area (left) and Euclidean distance vs the proportion of trips made by walking (right).
</p>
</div>
<p>Based on the right-hand panel in Figure , there is a clear negative relationship between distance of trips and the proportion of those trips made by walking. This is unsurprising: beyond a certain distance (around 1.5km according the the data presented in the figure above) walking is usually seen as too slow and other modes are considered. According to the academic literature, this ‘distance decay’ is non-linear and there have been a number of functions proposed to fit to distance decay curves . From the range of options we test below just two forms. We will compare the ability of linear and log-square-root functions to fit the data contained in <code>l</code> for walking.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lm1 &lt;-<span class="st"> </span><span class="kw">lm</span>(pwalk ~<span class="st"> </span>d_euclidean, <span class="dt">data =</span> l@data, <span class="dt">weights =</span> All)
lm2 &lt;-<span class="st"> </span><span class="kw">lm</span>(pwalk ~<span class="st"> </span>d_rf, <span class="dt">data =</span> l@data, <span class="dt">weights =</span> All)
lm3 &lt;-<span class="st"> </span><span class="kw">glm</span>(pwalk ~<span class="st"> </span>d_rf +<span class="st"> </span><span class="kw">I</span>(d_rf^<span class="fl">0.5</span>), 
           <span class="dt">data =</span> l@data, <span class="dt">weights =</span> All, <span class="dt">family =</span> <span class="kw">quasipoisson</span>(<span class="dt">link =</span> <span class="st">"log"</span>))</code></pre></div>
<p>The results of these regression models can be seen using <code>summary()</code>. Surprisingly, Euclidean distance was a better predictor of walking than route distance, but no strong conclusions can be drawn from this finding, with such a small sample of desire lines (n = 42). The results are purely illustrative, of the kind of the possibilities created by using <strong>stplanr</strong> in conjuction with R’s modelling capabilities (see Figure ).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(l$d_euclidean, l$pwalk, <span class="dt">cex =</span> l$All /<span class="st"> </span><span class="dv">50</span>,
  <span class="dt">xlab =</span> <span class="st">"Euclidean distance (m)"</span>, <span class="dt">ylab =</span> <span class="st">"Proportion of trips by foot"</span>)
l2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">d_euclidean =</span> <span class="dv">1</span>:<span class="dv">5000</span>, <span class="dt">d_rf =</span> <span class="dv">1</span>:<span class="dv">5000</span>)
lm1p &lt;-<span class="st"> </span><span class="kw">predict</span>(lm1, l2)
lm2p &lt;-<span class="st"> </span><span class="kw">predict</span>(lm2, l2)
lm3p &lt;-<span class="st"> </span><span class="kw">predict</span>(lm3, l2)
<span class="kw">lines</span>(l2$d_euclidean, lm1p)
<span class="kw">lines</span>(l2$d_euclidean, <span class="kw">exp</span>(lm2p), <span class="dt">col =</span> <span class="st">"green"</span>)
<span class="kw">lines</span>(l2$d_euclidean, <span class="kw">exp</span>(lm3p), <span class="dt">col =</span> <span class="st">"red"</span>)</code></pre></div>
<div class="figure" style="text-align: center">
<img src="stplanr-paper_files/figure-html/euclidwalking2-1.png" alt="Relationship between euclidean distance and walking" width="75%"><p class="caption">
Relationship between euclidean distance and walking
</p>
</div>
</div>
<div id="visualisation" class="section level2">
<h2 class="hasAnchor">
<a href="#visualisation" class="anchor"></a>Visualisation</h2>
<p>Visualisation is an important aspect of any transport study, as it enables researchers to communicate their findings to other researchers, policy-makers and, ultimately, the public. It may therefore come as a surprise that <strong>stplanr</strong> contains no functions for visualisation. Instead, users are encouraged to make use of existing spatial visualisation tools in R, such as <strong>tmap</strong>, <strong>leaflet</strong> and <strong>ggmap</strong> .</p>
<p>Furthermore, with the development of online application frameworks such as <strong>shiny</strong>, it is now easier than ever to make the results of transport analysis and modelling projects available to the public. An example is the online interface of the Propensity to Cycle Tool (PCT). The results of the project, generated using <strong>stplanr</strong>, are presented at zone, desire line and Route Network levels . There is great potential to expand on the principle of publicly accessible transport planning tools via ‘web apps’, perhaps through new R packages dedicated to visualising transport data.</p>
</div>
</div>
<div id="future-directions-of-travel" class="section level1">
<h1 class="hasAnchor">
<a href="#future-directions-of-travel" class="anchor"></a>Future directions of travel</h1>
<p>This paper has demonstrated the great potential for R to be used for transport planning. R’s flexibility, powerful GIS capabilities  and free accessibility makes it well-suited to the needs of transport planners and researchers, especially those wanting to avoid the high costs of market-leading products. Rather than ‘reinvent the wheel’ (e.g. with a new class system), <strong>stplanr</strong> builds on existing packages and  classes to work with common transport data formats.</p>
<p>It is useful to see <strong>stplanr</strong>, and R for transport planning in general, as an addition tool in the transport planner’s cabinet. It can be understood as one part of a wider movement that is making transport planning a more open and democratic process. Other developments in this movement include the increasing availability of open data  and the rise of open source products for transport modelling, such as <a href="http://www.dlr.de/ts/en/desktopdefault.aspx/tabid-9883/16931_read-41000/">SUMO</a>, <a href="http://www.matsim.org/">MATSim</a> and <a href="https://its.mit.edu/software/mitsimlab">MITSIMLAB</a> . <strong>stplanr</strong>, with its focus on GIS operations rather than microscopic vehicle-level behaviour, can complement such software and help make better use of new open data sources.</p>
<p>Because transport planning is an inherently spatial activity, <strong>stplanr</strong> occupies an important niche in the transport planning software landscape, with its focus on spatial transport data. There is great potential for development of <strong>stplanr</strong> in many directions. Desirable developments include the additional of functions for modelling modal split, for examample with functions to create commonly distance decay curves which are commonly found in active travel research  and improving the computational efficiency of existing functions to make the methods more scalable for large databases. Our priority for <strong>stplanr</strong> however, is to keep the focus on geographic functions for transport planning. There are many opportunities in this direction, including:</p>
<ul>
<li>Functions to assess the environment surrounding routes, e.g. via integration with the in-development <strong>osmdata</strong> package.</li>
<li>Functions to match different GIS routes, perhaps building on the Hausdorf distance algorithm implemented in the  function <code>gDistance</code>.</li>
<li>Additional functions for route-allocation of travel, e.g. via an interface to the OpenTripPlanner API.</li>
<li>Functions for aggregating very large GPS trace datasets (e.g. into raster cells) for anonymisation and analysis/visualisation purposes.</li>
<li>The creation of a class system for spatial transport datasets, such as to represent spatial route and a route networks (perhaps with classes named  and ). This is not a short-term priority and it would be beneficial to coincide such developments to a migration to  for spatial classes.</li>
</ul>
<p>Such spatial data processing capabilities would increase the range of transport planning tasks that <strong>stplanr</strong> can facilitate. For all this planned development activity to be useful, it is vital that new functionality is intuitive. R has a famously steep learning curve. Implementing simple concepts such as consistent naming systems  and ensuring ‘type stability’ can greatly improve the usability of the package. For this reason, much future work in <strong>stplanr</strong> will go into improving documentation and user-friendliness.</p>
<p>Like much open source software <strong>stplanr</strong> is an open-ended project, a work-in-progress. We have set out clear motivations for developing transport planning capabilities in R and believe that the current version of <strong>stplanr</strong> (0.1.6) provides a major step in that direction compared with what was available a couple of years ago. But there is much more to do. We therefore welcome input on where the package’s priorities should lie, how it should evolve in the future and how to ensure it is well-developed and sustained.</p>
<!-- This creates the opportunity for extending existing modelling and data analysis data to better handle typical travel survey formats, e.g. by creating a system to represent travel surveys worldwide by merging trip, individual and household level data. Such non-spatial extensions of R for transport planning could build on the fast grouping and processing functions provided by \CRANpkg{dplyr}. This is an interesting potential direction of travel for **stplanr** or future packages for transport research. -->
<!-- If you would like to contribute or request new features, see -->
<!-- https://github.com/Robinlovelace/stplanr -->

</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Most people can identify interventions that they think would make the transport systems they interact with more sustainable. Think about the paths and roads you travel on, for example: what interventions would you prioritise to improve non-motorised access, for walking, cycling and wheel-chairs? What quantitative evidence would you need to communicate this to the relevant authorities?<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>An API key is needed for this function to work. This can be requested (or purchased for large scale routing) from <a href="https://www.cyclestreets.net/api/apply/">cyclestreets.net/api/apply</a>. See <code><a href="../reference/route_cyclestreet.html">?route_cyclestreet</a></code> for details. Thanks to Martin Lucas-Smith and Simon Nuttall for making this possible.<a href="#fnref2">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#note">Note</a></li>
      <li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#motivations">Motivations</a></li>
      </ul>
</li>
      <li>
<a href="#package-structure-and-functionality">Package structure and functionality</a><ul class="nav nav-pills nav-stacked">
<li><a href="#core-functions-and-classes">Core functions and classes</a></li>
      <li><a href="#accessing-and-processing-transport-data">Accessing and processing transport data</a></li>
      <li><a href="#creating-geographic-desire-lines">Creating geographic desire lines</a></li>
      <li><a href="#allocating-flows-to-the-transport-network">Allocating flows to the transport network</a></li>
      <li><a href="#modelling-travel-catchment-areas">Modelling travel catchment areas</a></li>
      </ul>
</li>
      <li>
<a href="#modelling-and-visualisation">Modelling and visualisation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#modelling-mode-choice">Modelling mode choice</a></li>
      <li><a href="#models-of-travel-behaviour">Models of travel behaviour</a></li>
      <li><a href="#visualisation">Visualisation</a></li>
      </ul>
</li>
      <li><a href="#future-directions-of-travel">Future directions of travel</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robin Lovelace, Richard Ellison.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
